#!/usr/bin/env bash

# Find the real yarn, skipping this shim to avoid recursive calls
REAL_YARN=""
for p in $(type -aP yarn); do
  if [ "$p" != "${BASH_SOURCE[0]}" ] && [ "$p" != "$(readlink -f "${BASH_SOURCE[0]}")" ]; then
    REAL_YARN="$p"
    break
  fi
done

if [ -z "$REAL_YARN" ]; then
  echo "Error: could not find real yarn CLI" >&2
  exit 1
fi

# Rebuild PATH without the shim directory to prevent recursive calls
shim_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IFS=':' read -r -a path_parts <<< "$PATH"
new_path=()
for p in "${path_parts[@]}"; do
  [[ -n "$p" && "$p" != "$shim_dir" ]] && new_path+=("$p")
done
PATH=$(IFS=':'; echo "${new_path[*]}")
export PATH

# Check if we have auth helper, if not, just call yarn directly
AUTH_HELPER="$HOME/ado-auth-helper"
if command -v "$AUTH_HELPER" &> /dev/null; then
  ARTIFACTS_ACCESSTOKEN=$($AUTH_HELPER get-access-token) "$REAL_YARN" "$@"
else
  exec "$REAL_YARN" "$@"
fi